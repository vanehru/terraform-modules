name: Deploy Staging Environment

on:
  push:
    branches: [dev]
  workflow_dispatch:

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Validate AZURE_ACCOUNT_CRED secret
        shell: bash
        run: |
          if [ -z "${{ secrets.AZURE_ACCOUNT_CRED }}" ]; then
            echo "::error title=Missing secret::AZURE_ACCOUNT_CRED not set"
            exit 1
          fi
          json='${{ secrets.AZURE_ACCOUNT_CRED }}'
          cid=$(echo "$json" | jq -r '.clientId // .appId // empty')
          csec=$(echo "$json" | jq -r '.clientSecret // .password // empty')
          tid=$(echo "$json" | jq -r '.tenantId // .tenant // empty')
          sid=$(echo "$json" | jq -r '.subscriptionId // empty')
          missing(){ echo "::error title=Missing field::$1 missing or null"; fail=1; }
          [ -n "$cid" ] || missing clientId/appId
          [ -n "$csec" ] || missing clientSecret/password
          [ -n "$tid" ] || missing tenantId/tenant
          [ -n "$sid" ] || missing subscriptionId
          if [ "${fail:-0}" = 1 ]; then
            echo "AZURE_ACCOUNT_CRED secret incomplete"; exit 1; fi
          echo "AZURE_ACCOUNT_CRED secret validated (clientId=$cid)."

      - name: Extract Azure SP values
        id: extract-sp
        shell: bash
        run: |
          json='${{ secrets.AZURE_ACCOUNT_CRED }}'
          cid=$(echo "$json" | jq -r '.clientId // .appId')
          csec=$(echo "$json" | jq -r '.clientSecret // .password')
          tid=$(echo "$json" | jq -r '.tenantId // .tenant')
          sid=$(echo "$json" | jq -r '.subscriptionId')
          echo "ARM_CLIENT_ID=$cid" >> $GITHUB_ENV
          echo "ARM_CLIENT_SECRET=$csec" >> $GITHUB_ENV
          echo "ARM_TENANT_ID=$tid" >> $GITHUB_ENV
          echo "ARM_SUBSCRIPTION_ID=$sid" >> $GITHUB_ENV
          echo "clientId=$cid" >> $GITHUB_OUTPUT

      - name: Azure Login (Service Principal explicit)
        uses: azure/login@v1
        with:
          creds: '{"clientId":"${{ env.ARM_CLIENT_ID }}","clientSecret":"${{ env.ARM_CLIENT_SECRET }}","subscriptionId":"${{ env.ARM_SUBSCRIPTION_ID }}","tenantId":"${{ env.ARM_TENANT_ID }}"}'
          enable-AzPSSession: true

      - name: Deploy Infrastructure
        working-directory: demo-rpg-aiapp/infra
        env:
          ARM_CLIENT_ID: ${{ fromJSON(secrets.AZURE_ACCOUNT_CRED).clientId }}
          ARM_CLIENT_SECRET: ${{ fromJSON(secrets.AZURE_ACCOUNT_CRED).clientSecret }}
          ARM_SUBSCRIPTION_ID: ${{ fromJSON(secrets.AZURE_ACCOUNT_CRED).subscriptionId }}
          ARM_TENANT_ID: ${{ fromJSON(secrets.AZURE_ACCOUNT_CRED).tenantId }}
        run: |
          # Read RG name from staging tfvars and import if it already exists
          RG_NAME=$(awk -F= '/^azurerm_resource_group_name/ {gsub(/[" ]/,"",$2); print $2}' environments/staging.tfvars)
          echo "Using resource group: $RG_NAME"
          terraform init
          if az group show -n "$RG_NAME" >/dev/null 2>&1; then
            echo "Resource group $RG_NAME exists. Importing into terraform state if not present."
            terraform import -var-file="environments/staging.tfvars" azurerm_resource_group.rg /subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/$RG_NAME || true
          else
            echo "Resource group $RG_NAME does not exist. Will be created by terraform."
          fi
          terraform apply -var-file="environments/staging.tfvars" -auto-approve
